<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>GitHub Webhook Setup</title>
    <script src="https://cdn.tailwindcss.com"></script>
  </head>
  <body class="bg-gray-100 text-gray-800 min-h-screen flex flex-col gap-4 items-center justify-center p-4">

    <div class="bg-white max-w-2xl w-full rounded-2xl shadow-lg p-6 space-y-4">
      <h1 class="text-3xl font-bold text-center text-blue-600">GitHub Webhook Server</h1>
      <p class="text-center text-gray-600">Follow the steps below to set it up properly</p>

      <div class="space-y-4 text-sm">
        <h2 class="text-xl font-semibold mt-4">üîß Setup Instructions</h2>
        <ol class="list-decimal list-inside space-y-2">
          <li>
            Go to your repository on GitHub.
          </li>
          <li>
            Click on <strong>Settings</strong> &gt; <strong>Webhooks</strong> &gt; <strong>Add webhook</strong>.
          </li>
          <li>
            In <strong>Payload URL</strong>, enter your server URL:<br />
            <code class="bg-gray-200 p-1 rounded">https://webhook.c2coder.eu/webhook</code>
          </li>
          <li>
            Set <strong>Content type</strong> to <code class="bg-gray-200 p-1 rounded">application/json</code>.
          </li>
          <li>
            Choose the events you want (e.g., <strong>Push</strong>, <strong>Pull Request</strong>, I use <strong>All</strong>).
          </li>
          <li>
            Add a <strong>secret</strong>. It is stored in the <code class="bg-gray-200 p-1 rounded">.env</code> file.
          </li>
          <li>
            Click <strong>Add webhook</strong>.
          </li>
        </ol>

        <h2 class="text-xl font-semibold mt-4">üß™ Testing</h2>
        <p>
          You can test it by clicking <strong>‚ÄúRecent Deliveries‚Äù</strong> in the webhook settings. Make sure your server logs the request.
        </p>

        <h2 class="text-xl font-semibold mt-4">üìú Notes</h2>
        <ul class="list-disc list-inside">
          <li>Ensure your server is publicly accessible (use a domain or public IP).</li>
          <li>If running locally, use a tool like <code class="bg-gray-200 p-1 rounded">ngrok</code>.</li>
          <li>Use HTTPS for security ‚Äî GitHub requires it.</li>
        </ul>
      </div>

      <div class="text-center mt-4">
        <a href="https://github.com/C2Coder/RoboCamp-localPages" target="_blank" rel="noopener noreferrer"
           class="inline-flex items-center gap-2 px-4 py-2 bg-blue-600 text-white rounded-lg shadow hover:bg-blue-700 transition">
          <svg class="w-5 h-5" fill="currentColor" viewBox="0 0 24 24" aria-hidden="true">
            <path d="M12 .297c-6.63 0-12 5.373-12 12 0 5.303 3.438 9.8 8.205 11.385.6.113.82-.258.82-.577 0-.285-.01-1.04-.015-2.04-3.338.724-4.042-1.61-4.042-1.61-.546-1.387-1.333-1.756-1.333-1.756-1.089-.745.083-.729.083-.729 1.205.084 1.84 1.236 1.84 1.236 1.07 1.834 2.809 1.304 3.495.997.108-.775.418-1.305.762-1.605-2.665-.305-5.466-1.332-5.466-5.93 0-1.31.469-2.381 1.236-3.221-.124-.303-.535-1.523.117-3.176 0 0 1.008-.322 3.301 1.23a11.52 11.52 0 0 1 3.003-.404c1.018.005 2.045.138 3.003.404 2.291-1.552 3.297-1.23 3.297-1.23.653 1.653.242 2.873.118 3.176.77.84 1.235 1.911 1.235 3.221 0 4.61-2.803 5.624-5.475 5.921.43.372.823 1.102.823 2.222 0 1.606-.014 2.898-.014 3.293 0 .322.218.694.825.576C20.565 22.092 24 17.592 24 12.297c0-6.627-5.373-12-12-12"/>
          </svg>
          Source on GitHub
        </a>
      </div>

      <footer class="text-center text-xs text-gray-500 mt-6">
        &copy; {year} <a class="font-semibold" href="https://github.com/C2Coder" target="_blank" rel="noopener noreferrer">C2Coder</a>. Made and hosted with ‚ù§Ô∏è
      </footer>
    </div>

    <div class="bg-white max-w-2xl w-full rounded-2xl shadow-lg p-6 space-y-4">
      <h1 class="text-3xl font-bold text-center text-blue-600">20 Most recent (useful) deliveries</h1>
      <div id="recent-deliveries" class="space-y-2">
      </div>
    </div>
  </body>
</html>
<script>
  // Fetch and display recent deliveries
  async function fetchRecentDeliveries() {
    try {
      const response = await fetch('/webhook/recent-useful-deliveries');
      if (!response.ok) throw new Error('Network response was not ok');
      const data = await response.json();
      const container = document.querySelector('#recent-deliveries');
      const list = document.createElement('ul');
      list.className = 'list-disc list-inside space-y-2';
      
      data.forEach(event => {
        const item = document.createElement('li');
        item.className = 'p-2 bg-gray-100 rounded-lg shadow-sm flex flex-row items-center gap-1';
        const eventTypeAliases = {
          "ping": "Ping",
          "push": "Push",
          "pull_request": "Pull Request",
          "page_build": "Page Build",
          "deployment": "Deployment",
          "deployment_status": "Deployment Status",
          "workflow_run": "Workflow Run",
          "workflow_job": "Workflow Job",
          "check_run": "Check Run",
          "check_suite": "Check Suite",
        };
        let eventType = event.event_type || 'Unknown';
        eventType = eventTypeAliases[eventType] || eventType;
        const repo = event.repository || 'Unknown';

        const date = new Date(event.timestamp);
        const formatted = `${date.getDate()}-${date.getMonth() + 1}-${date.getFullYear()} ` +
                  `${date.getHours().toString().padStart(2, '0')}:` +
                  `${date.getMinutes().toString().padStart(2, '0')}:` +
                  `${date.getSeconds().toString().padStart(2, '0')}`;


        item.innerHTML = `<strong>${eventType}</strong> in <strong>${repo}</strong> at ${formatted}`;

        list.appendChild(item);
      });
      
      container.appendChild(list);
    } catch (error) {
      console.error('Error fetching recent deliveries:', error);
    }
  }

  // Call the function to fetch deliveries
  fetchRecentDeliveries();
    </script>